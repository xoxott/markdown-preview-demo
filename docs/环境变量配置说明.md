# 环境变量配置说明

## 📋 业务状态码配置详解

根据后端的业务错误码体系，前端需要正确配置以下环境变量来处理不同的错误场景。

### 🎯 业务错误码体系

```typescript
// HTTP 状态码 (后端返回，前端不配置)
200, 201, 204, 400, 401, 403, 404, 500...

// 业务状态码 (在响应体的 code 字段中，需要在环境变量中配置)
200, 201, 204    // 成功
1xxx, 2xxx, 5xxx // 错误
```

---

## 1️⃣ 成功状态码配置

### 环境变量
```env
VITE_SERVICE_SUCCESS_CODE=200,201
```

### 说明
- **200**: 通用成功（查询、更新等操作）
- **201**: 创建成功（新建资源）

### 代码中的应用
```typescript
// src/service/request/index.ts
function isBackendSuccess(response) {
  const code = response.data.code;
  return code === 200 || code === 201;
}
```

---

## 2️⃣ Token 过期可刷新错误码

### 环境变量
```env
VITE_SERVICE_EXPIRED_TOKEN_CODES=1202
```

### 说明
- **1202**: TOKEN_EXPIRED - Access token 已过期但可以刷新

### 错误响应示例
```json
{
  "code": 1202,
  "message": "Access token has expired",
  "details": {
    "context": {
      "httpStatus": 401,
      "error": "Token Expired"
    }
  },
  "timestamp": "2025-12-07T12:05:11.621Z",
  "path": "/api/admin/roles"
}
```

### 处理流程
```
1. 检测到 code = 1202
   ↓
2. 调用 /api/admin/auth/refresh 刷新 token
   ↓
3. 刷新成功？
   ├─ 是 → 使用新 token 重新发送原请求 ✅
   └─ 否 → 执行登出逻辑 ❌
```

### 代码中的应用
```typescript
// src/service/request/index.ts
function getExpiredTokenCodes(): string[] {
  const codes = import.meta.env.VITE_SERVICE_EXPIRED_TOKEN_CODES?.split(',').filter(Boolean);
  return codes && codes.length > 0 ? codes : ['1202']; // 默认值
}

async function onBackendFail(response, instance) {
  const errorCode = extractErrorCode(response.data);
  const expiredTokenCodes = getExpiredTokenCodes();

  // 1. 尝试刷新 token
  if (expiredTokenCodes.includes(errorCode)) {
    const success = await handleExpiredRequest(request.state);
    if (success) {
      const newToken = getAuthorization();
      return instance.request(createRetryConfig(response, newToken!));
    }
  }
  // ...
}
```

---

## 3️⃣ 立即登出错误码

### 环境变量
```env
VITE_SERVICE_LOGOUT_CODES=1200,1201,1203,1204,1205
```

### 说明
| 错误码 | 含义 | 说明 |
|--------|------|------|
| 1200 | AUTHENTICATION_FAILED | 认证失败 |
| 1201 | INVALID_CREDENTIALS | 用户名或密码错误 |
| 1203 | TOKEN_INVALID | Token 格式无效或被篡改 |
| 1204 | TOKEN_REVOKED | Token 已被手动撤销 |
| 1205 | SESSION_EXPIRED | 会话超时需要重新登录 |

### 处理流程
```
检测到以上错误码
   ↓
立即执行登出（不显示提示）
   ↓
清除本地存储的 token 和用户信息
   ↓
重定向到登录页
```

### 代码中的应用
```typescript
// src/service/request/index.ts
function getLogoutCodes(): string[] {
  return import.meta.env.VITE_SERVICE_LOGOUT_CODES?.split(',').filter(Boolean) || [];
}

async function onBackendFail(response, instance) {
  const errorCode = extractErrorCode(response.data);
  const logoutCodes = getLogoutCodes();

  // 认证相关错误码
  const authErrorCodes = ['1200', '1201', '1203', '1204', '1205'];

  // 2. 处理需要登出的错误码
  const shouldLogout =
    !expiredTokenCodes.includes(errorCode) &&
    (authErrorCodes.includes(errorCode) || logoutCodes.includes(errorCode));

  if (shouldLogout) {
    authStore.resetStore(); // 清除状态并跳转登录页
    return null;
  }
  // ...
}
```

---

## 4️⃣ 模态框提示登出错误码

### 环境变量
```env
VITE_SERVICE_MODAL_LOGOUT_CODES=1206,1207,2000
```

### 说明
| 错误码 | 含义 | 说明 |
|--------|------|------|
| 1206 | ACCOUNT_LOCKED | 账号因多次登录失败被锁定 |
| 1207 | ACCOUNT_DISABLED | 账号被管理员禁用 |
| 2000 | ACCOUNT_BLACKLISTED | 账号因违规被列入黑名单 |

### 处理流程
```
检测到以上错误码
   ↓
显示模态框，告知用户原因
   ↓
用户点击确认
   ↓
执行登出并跳转登录页
```

### 代码中的应用
```typescript
// src/service/request/index.ts
function getModalLogoutCodes(): string[] {
  return import.meta.env.VITE_SERVICE_MODAL_LOGOUT_CODES?.split(',').filter(Boolean) || [];
}

async function onBackendFail(response, instance) {
  const errorCode = extractErrorCode(response.data);
  const modalLogoutCodes = getModalLogoutCodes();

  // 3. 处理需要显示模态框的错误码
  if (modalLogoutCodes.includes(errorCode)) {
    window.$dialog?.error({
      title: '账号异常',
      content: response.data.message,
      positiveText: '确定',
      maskClosable: false,
      closeOnEsc: false,
      onPositiveClick: () => {
        authStore.resetStore();
      }
    });
    return null;
  }
  // ...
}
```

---

## 🔍 完整的错误处理优先级

```typescript
1. Token 过期可刷新 (1202)
   → 尝试刷新 token

2. 立即登出 (1200, 1201, 1203, 1204, 1205)
   → 直接登出，不提示

3. 模态框提示登出 (1206, 1207, 2000)
   → 显示模态框说明原因后登出

4. 其他业务错误 (1xxx, 2xxx, 5xxx)
   → 显示错误消息提示
```

---

## 📝 配置示例

### 开发环境 (`.env.development`)
```env
# 开发环境可能需要更详细的日志
VITE_SERVICE_EXPIRED_TOKEN_CODES=1202
VITE_SERVICE_LOGOUT_CODES=1200,1201,1203,1204,1205
VITE_SERVICE_MODAL_LOGOUT_CODES=1206,1207,2000
VITE_PROXY_LOG=Y
```

### 生产环境 (`.env.production`)
```env
# 生产环境使用相同的业务码配置
VITE_SERVICE_EXPIRED_TOKEN_CODES=1202
VITE_SERVICE_LOGOUT_CODES=1200,1201,1203,1204,1205
VITE_SERVICE_MODAL_LOGOUT_CODES=1206,1207,2000
VITE_PROXY_LOG=N
```

---

## ⚠️ 注意事项

1. **只配置业务错误码**
   - ❌ 不要配置 HTTP 状态码（400, 401, 403 等）
   - ✅ 只配置业务错误码（1xxx, 2xxx, 5xxx）

2. **逗号分隔**
   - 多个错误码使用英文逗号分隔
   - 不要有空格：`1200,1201,1203` ✅
   - 不要这样：`1200, 1201, 1203` ❌

3. **错误码不要重复**
   - 同一个错误码不要同时配置在多个环境变量中
   - 例如：1202 只能配置在 `EXPIRED_TOKEN_CODES` 中

4. **默认值**
   - 代码中已提供合理的默认值
   - 即使不配置环境变量，也能正常工作

5. **修改后需重启**
   - 修改 `.env` 文件后需要重启 Vite 开发服务器
   - 生产环境需要重新构建

---

## 🧪 测试方法

### 测试 Token 刷新
```bash
# 1. 登录获取 token
# 2. 等待 60 秒让 access token 过期
# 3. 发起任意 API 请求
# 4. 观察控制台日志，应该看到：
#    [Token Refresh] 检测到 token 过期，开始刷新 token，errorCode: 1202
#    [Token Refresh] Token 刷新成功，重新发送请求
```

### 测试立即登出
```bash
# 手动在浏览器控制台设置一个无效的 token
localStorage.setItem('token', 'invalid-token');
# 刷新页面并发起请求
# 应该立即跳转到登录页
```

### 测试模态框登出
```bash
# 需要后端返回 1206, 1207 或 2000 错误码
# 应该显示模态框说明原因
# 点击确认后才跳转登录页
```

---

## 📚 相关文件

- **环境变量定义**: `src/typings/vite-env.d.ts`
- **环境变量示例**: `.env.example`
- **错误处理逻辑**: `src/service/request/index.ts`
- **Token 刷新逻辑**: `src/service/request/shared.ts`
- **业务错误码常量**: 后端 `src/constants/business-error-codes.ts`

