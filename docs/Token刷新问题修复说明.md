# Token åˆ·æ–°é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

å½“ Access Token è¿‡æœŸæ—¶ï¼Œåç«¯è¿”å›ï¼š
```json
{
  "code": 1202,
  "message": "Access token has expired",
  "details": { ... },
  "timestamp": "2025-12-07T13:59:34.945Z"
}
```

HTTP çŠ¶æ€ç ä¸º **401**ï¼Œä½†å‰ç«¯æ²¡æœ‰è‡ªåŠ¨è§¦å‘ token åˆ·æ–°æœºåˆ¶ã€‚

## ğŸ” é—®é¢˜åŸå› 

### åŸé—®é¢˜
axios çš„ `validateStatus` é…ç½®åªè®¤ä¸º HTTP çŠ¶æ€ç  200-299 å’Œ 304 æ˜¯"æˆåŠŸ"çš„ï¼š

```typescript
// packages/axios/src/shared.ts
export function isHttpSuccess(status: number) {
  const isSuccessCode = status >= 200 && status < 300;
  return isSuccessCode || status === 304;
}
```

### å¯¼è‡´çš„é—®é¢˜æµç¨‹

```
1. API è¿”å›: HTTP 401 + code 1202
   â†“
2. axios validateStatus åˆ¤æ–­: 401 ä¸æ˜¯æˆåŠŸçŠ¶æ€
   â†“
3. axios æŠ›å‡ºé”™è¯¯ï¼Œè¿›å…¥ onError
   â†“
4. onError åªæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼Œä¸å¤„ç† token åˆ·æ–°
   â†“
5. âŒ Token åˆ·æ–°é€»è¾‘æ²¡æœ‰è§¦å‘
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹ validateStatus é…ç½®

å°† HTTP 401 ä¹Ÿè§†ä¸ºæœ‰æ•ˆå“åº”ï¼Œè®©ä¸šåŠ¡é€»è¾‘æ¥åˆ¤æ–­æ˜¯å¦çœŸæ­£æˆåŠŸï¼š

```typescript
// packages/axios/src/shared.ts
export function isHttpSuccess(status: number) {
  const isSuccessCode = status >= 200 && status < 300;
  // 401 ä¹Ÿè§†ä¸ºæˆåŠŸï¼Œå› ä¸ºä¸šåŠ¡é”™è¯¯ï¼ˆå¦‚ token è¿‡æœŸï¼‰åº”è¯¥ç”± isBackendSuccess å’Œ onBackendFail å¤„ç†
  // çœŸæ­£çš„ä¸šåŠ¡çŠ¶æ€ç”±å“åº”ä½“ä¸­çš„ code å­—æ®µå†³å®šï¼Œè€Œä¸æ˜¯ HTTP çŠ¶æ€ç 
  return isSuccessCode || status === 304 || status === 401;
}
```

### ä¿®å¤åçš„æµç¨‹

```
1. API è¿”å›: HTTP 401 + code 1202
   â†“
2. axios validateStatus åˆ¤æ–­: 401 è¢«è§†ä¸ºæœ‰æ•ˆå“åº” âœ…
   â†“
3. è¿›å…¥ isBackendSuccess åˆ¤æ–­: code !== 200/201
   â†“
4. è¿›å…¥ onBackendFail å¤„ç†
   â†“
5. æ£€æµ‹åˆ° errorCode = 1202ï¼Œåœ¨ expiredTokenCodes ä¸­
   â†“
6. âœ… è§¦å‘ token åˆ·æ–°é€»è¾‘
   â†“
7. åˆ·æ–°æˆåŠŸåé‡æ–°å‘é€åŸè¯·æ±‚
```

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### HTTP çŠ¶æ€ç  vs ä¸šåŠ¡çŠ¶æ€ç 

| ç±»å‹ | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|
| **HTTP çŠ¶æ€ç ** | ä¼ è¾“å±‚çŠ¶æ€ï¼Œè¡¨ç¤ºè¯·æ±‚æ˜¯å¦æˆåŠŸåˆ°è¾¾ | 200, 401, 404, 500 |
| **ä¸šåŠ¡çŠ¶æ€ç  (code)** | ä¸šåŠ¡å±‚çŠ¶æ€ï¼Œè¡¨ç¤ºä¸šåŠ¡é€»è¾‘æ˜¯å¦æˆåŠŸ | 200=æˆåŠŸ, 1202=tokenè¿‡æœŸ |

### å¤„ç†åŸåˆ™

1. **HTTP 401 ä¸ä»£è¡¨ä¸šåŠ¡å¤±è´¥**
   - åªæ˜¯è¡¨ç¤ºéœ€è¦è®¤è¯
   - å“åº”ä½“ä¸­çš„ `code` æ‰æ˜¯çœŸæ­£çš„ä¸šåŠ¡çŠ¶æ€

2. **ä¸šåŠ¡é€»è¾‘ç”± code å­—æ®µå†³å®š**
   ```typescript
   isBackendSuccess(response) {
     const code = response.data.code;
     return code === 200 || code === 201;
   }
   ```

3. **ç‰¹æ®Šä¸šåŠ¡åœºæ™¯ç”± onBackendFail å¤„ç†**
   - Token è¿‡æœŸåˆ·æ–° (code=1202)
   - è´¦å·å¼‚å¸¸ç™»å‡º (code=1200,1201,1203...)
   - æ¨¡æ€æ¡†æç¤º (code=1206,1207,2000)

## ğŸ“Š å®Œæ•´çš„è¯·æ±‚å“åº”æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å‘èµ· API è¯·æ±‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           axios validateStatus æ£€æŸ¥              â”‚
â”‚   HTTP 401 â†’ è§†ä¸ºæœ‰æ•ˆå“åº” âœ…                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         isBackendSuccess ä¸šåŠ¡çŠ¶æ€æ£€æŸ¥            â”‚
â”‚   code = 1202 â†’ ä¸šåŠ¡å¤±è´¥ âŒ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            onBackendFail é”™è¯¯å¤„ç†                â”‚
â”‚                                                  â”‚
â”‚  1ï¸âƒ£ errorCode = 1202 (åœ¨ expiredTokenCodes ä¸­)  â”‚
â”‚     â†“                                            â”‚
â”‚  è°ƒç”¨ handleExpiredRequest(request.state)       â”‚
â”‚     â†“                                            â”‚
â”‚  è°ƒç”¨ /api/admin/auth/refresh                   â”‚
â”‚     â†“                                            â”‚
â”‚  åˆ·æ–°æˆåŠŸï¼Ÿ                                       â”‚
â”‚  â”œâ”€ æ˜¯ â†’ ä½¿ç”¨æ–° token é‡è¯•åŸè¯·æ±‚ âœ…               â”‚
â”‚  â””â”€ å¦ â†’ æ‰§è¡Œç™»å‡ºé€»è¾‘ âŒ                          â”‚
â”‚                                                  â”‚
â”‚  2ï¸âƒ£ errorCode = 1200,1201,1203... (è®¤è¯å¤±è´¥)     â”‚
â”‚     â†’ ç«‹å³ç™»å‡º                                   â”‚
â”‚                                                  â”‚
â”‚  3ï¸âƒ£ errorCode = 1206,1207,2000 (è´¦å·å¼‚å¸¸)        â”‚
â”‚     â†’ æ˜¾ç¤ºæ¨¡æ€æ¡†åç™»å‡º                            â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. æµ‹è¯• Token è‡ªåŠ¨åˆ·æ–°

```bash
# 1. ç™»å½•ç³»ç»Ÿ
# 2. åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š

# åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š
[Request] isBackendSuccess check: {
  code: 1202,
  isSuccess: false,
  url: '/api/admin/roles',
  status: 401
}

[Request] onBackendFail triggered: {
  errorCode: '1202',
  expiredTokenCodes: ['1202'],
  url: '/api/admin/roles',
  status: 401,
  message: 'Access token has expired'
}

[Token Refresh] æ£€æµ‹åˆ° token è¿‡æœŸï¼Œå¼€å§‹åˆ·æ–° tokenï¼ŒerrorCode: 1202
[Token Refresh] å¼€å§‹è°ƒç”¨åˆ·æ–° token API
[Token Refresh] Token åˆ·æ–°æˆåŠŸ
[Token Refresh] SSE connections updated with new token
[Token Refresh] Token åˆ·æ–°æˆåŠŸï¼Œé‡æ–°å‘é€è¯·æ±‚

# 3. åŸè¯·æ±‚ä¼šè‡ªåŠ¨é‡è¯•å¹¶æˆåŠŸ
```

### 2. æµ‹è¯•ç¯å¢ƒå˜é‡é…ç½®

```bash
# åœ¨ .env æ–‡ä»¶ä¸­ä¿®æ”¹é…ç½®
VITE_SERVICE_EXPIRED_TOKEN_CODES=1202,1205

# é‡å¯å¼€å‘æœåŠ¡å™¨
npm run dev

# éªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆï¼ˆåœ¨æ§åˆ¶å°æ‰§è¡Œï¼‰ï¼š
import.meta.env.VITE_SERVICE_EXPIRED_TOKEN_CODES
// åº”è¯¥è¾“å‡º: "1202,1205"
```

### 3. æµ‹è¯•åˆ·æ–°å¤±è´¥åœºæ™¯

```bash
# 1. æ‰‹åŠ¨æ¸…é™¤ refresh token
localStorage.removeItem('refreshToken');

# 2. ç­‰å¾… access token è¿‡æœŸ

# 3. å‘èµ·ä»»æ„ API è¯·æ±‚

# åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š
[Token Refresh] æ£€æµ‹åˆ° token è¿‡æœŸï¼Œå¼€å§‹åˆ·æ–° token
[Token Refresh] Refresh token ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ·æ–°
[Token Refresh] Token åˆ·æ–°å¤±è´¥ï¼Œå°†æ‰§è¡Œç™»å‡ºé€»è¾‘

# 4. è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
```

## ğŸ”§ è°ƒè¯•æŠ€å·§

### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—

å·²åœ¨ä»£ç ä¸­æ·»åŠ è¯¦ç»†çš„ console.logï¼Œå…³é”®æ—¥å¿—åŒ…æ‹¬ï¼š

```typescript
// æ£€æŸ¥å“åº”æ˜¯å¦è¢«æ­£ç¡®å¤„ç†
[Request] isBackendSuccess check

// æ£€æŸ¥æ˜¯å¦è¿›å…¥é”™è¯¯å¤„ç†
[Request] onBackendFail triggered

// æ£€æŸ¥ token åˆ·æ–°æµç¨‹
[Token Refresh] æ£€æµ‹åˆ° token è¿‡æœŸ
[Token Refresh] å¼€å§‹è°ƒç”¨åˆ·æ–° token API
[Token Refresh] Token åˆ·æ–°æˆåŠŸ/å¤±è´¥
```

### 2. æ£€æŸ¥ç¯å¢ƒå˜é‡

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
console.log({
  expiredCodes: import.meta.env.VITE_SERVICE_EXPIRED_TOKEN_CODES,
  logoutCodes: import.meta.env.VITE_SERVICE_LOGOUT_CODES,
  modalLogoutCodes: import.meta.env.VITE_SERVICE_MODAL_LOGOUT_CODES
});
```

### 3. æ‰‹åŠ¨è§¦å‘ token è¿‡æœŸ

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼Œè®¾ç½®ä¸€ä¸ªå³å°†è¿‡æœŸçš„ token
// æ³¨æ„ï¼šéœ€è¦åç«¯é…åˆç”Ÿæˆä¸€ä¸ªçŸ­æœŸ token
localStorage.setItem('token', 'your-short-lived-token');
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¿®æ”¹åéœ€è¦é‡å¯å¼€å‘æœåŠ¡å™¨**
   ```bash
   # åœæ­¢å½“å‰æœåŠ¡å™¨ (Ctrl+C)
   npm run dev
   ```

2. **ç”Ÿäº§ç¯å¢ƒéœ€è¦é‡æ–°æ„å»º**
   ```bash
   npm run build
   ```

3. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
   - ä¿®æ”¹åå»ºè®®æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
   - æˆ–è€…ä½¿ç”¨éšç§æ¨¡å¼æµ‹è¯•

4. **æ£€æŸ¥åç«¯é…ç½®**
   - ç¡®ä¿åç«¯ token è¿‡æœŸæ—¶è¿”å› code = 1202
   - ç¡®ä¿ refresh token æ¥å£æ­£å¸¸å·¥ä½œ

## ğŸ“š ç›¸å…³æ–‡ä»¶

- **HTTP çŠ¶æ€éªŒè¯**: `packages/axios/src/shared.ts`
- **è¯·æ±‚æ‹¦æˆªå™¨**: `src/service/request/index.ts`
- **Token åˆ·æ–°é€»è¾‘**: `src/service/request/shared.ts`
- **ç¯å¢ƒå˜é‡é…ç½®**: `env.example.txt`
- **ç±»å‹å®šä¹‰**: `src/typings/vite-env.d.ts`

## âœ… éªŒè¯æ¸…å•

- [ ] HTTP 401 å“åº”èƒ½æ­£ç¡®è¿›å…¥ `onBackendFail`
- [ ] Token è¿‡æœŸæ—¶è‡ªåŠ¨è§¦å‘åˆ·æ–°
- [ ] åˆ·æ–°æˆåŠŸååŸè¯·æ±‚è‡ªåŠ¨é‡è¯•
- [ ] åˆ·æ–°å¤±è´¥åè‡ªåŠ¨ç™»å‡º
- [ ] æ§åˆ¶å°æ—¥å¿—å®Œæ•´è¾“å‡º
- [ ] ç¯å¢ƒå˜é‡é…ç½®ç”Ÿæ•ˆ

