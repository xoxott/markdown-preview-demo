import{av as k}from"./MarkdownPreview-CUEz8Zi4.js";import{d as S,r as u,a as y,o as w,b as _,e as m,w as x,a1 as N,a2 as T,a3 as I,a4 as E,g as h,a5 as A,a0 as B,f as O,B as R,n as H,a6 as V}from"./index-saEpKK3w.js";import{N as $}from"./Spin-BYs-ry5f.js";import"./use-theme-vars-BIXdptPX.js";import"./FileCode-DY-iW2wB.js";import"./Space-DXVLf2rs.js";import"./installCanvasRenderer-B4Gou539.js";async function j(b,c,s="openChat",l={}){try{const r=new AbortController,d=l.timeout?setTimeout(()=>r.abort(),l.timeout):null,p=await fetch("http://localhost:11434/api/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:s,prompt:b,stream:!0}),signal:l.signal||r.signal});if(!p.ok)throw new Error(`请求失败: ${p.status} ${p.statusText}`);if(!p.body)throw new Error("响应体不可读");const v=p.body.getReader(),g=new TextDecoder("utf-8");let i="",f=!1;await(async()=>{try{for(;!f;){const{done:a,value:n}=await v.read();if(a){if(f=!0,i.trim())try{const t=JSON.parse(i);t.response&&c(t.response)}catch(t){console.warn("流结束时的缓冲区解析失败:",i,t)}break}i+=g.decode(n,{stream:!0});const e=i.split(`
`);i=e.pop()||"";for(const t of e)if(t.trim())try{const o=JSON.parse(t);if(o.done){f=!0;break}console.log(o),o.response&&(console.log(o),c(o.response))}catch(o){console.warn("流响应解析失败:",t,o),i=`${t}
${i}`;break}}}catch(a){if(a.name!=="AbortError")throw a}finally{d&&clearTimeout(d),v.releaseLock()}})()}catch(r){throw r.name==="AbortError"?new Error("请求超时"):r}}const z={class:"chat-page"},J={class:"chat-container"},P={key:0,class:"message ai loading"},D={class:"chat-input"},L=20,M=S({name:"chat",__name:"index",setup(b){const c=u(""),s=u([]),l=u(!1),r=u([]),d=u(!1),p=u(null),v=u(!1),g=u(0),i=a=>{const n=a.target,e=n.scrollTop,t=n.scrollHeight,o=n.clientHeight;v.value=e<g.value,t-(e+o)<50&&(v.value=!1),g.value=e},f=()=>{if(r.value.length===0||d.value)return;d.value=!0;const{index:a,token:n}=r.value.shift();s.value[a].displayContent||(s.value[a].displayContent="");let e=0;const t=setInterval(()=>{e<n.length?(s.value[a].displayContent+=n.charAt(e),e++):(clearInterval(t),d.value=!1,H(()=>{r.value.length>0&&f()}))},L)},C=async()=>{var t;const a=c.value.trim();if(!a)return;s.value.push({role:"user",content:a,displayContent:a}),c.value="",l.value=!0;const n={role:"ai",content:"",displayContent:"▋"};s.value.push(n);const e=s.value.length-1;try{await j(a,o=>{r.value.push({index:e,token:o}),s.value[e].content+=o,d.value||f()})}catch(o){s.value[e].displayContent="⚠️ AI 响应失败",console.error(o)}finally{(t=s.value[e].displayContent)!=null&&t.endsWith("▋")&&(s.value[e].displayContent=s.value[e].displayContent.slice(0,-1)),l.value=!1}};return(a,n)=>(w(),y("div",z,[_("div",J,[m(h(A),{ref_key:"scrollbarRef",ref:p,class:"chat-messages",trigger:"none",onScroll:i},{default:x(()=>[(w(!0),y(T,null,I(s.value,(e,t)=>(w(),y("div",{key:t,class:E(["message",[e.role]])},[m(h(k),{content:e.content},null,8,["content"])],2))),128)),l.value?(w(),y("div",P,[m(h($),{size:"small"})])):N("",!0)]),_:1},512),_("div",D,[m(h(B),{value:c.value,"onUpdate:value":n[0]||(n[0]=e=>c.value=e),type:"textarea",placeholder:"请输入你的问题...",disabled:l.value,autosize:{minRows:5,maxRows:5}},null,8,["value","disabled"]),m(h(R),{type:"primary",disabled:l.value||!c.value.trim(),loading:l.value,onClick:C},{default:x(()=>n[1]||(n[1]=[O(" 发送 ")])),_:1},8,["disabled","loading"])])])]))}}),X=V(M,[["__scopeId","data-v-e3d8164b"]]);export{X as default};
