import{as as k}from"./index.vue_vue_type_style_index_0_lang-DcpF90Fn.js";import{N as S}from"./Spin-BI_Y0tGL.js";import{d as N,F as u,a as g,o as y,b as C,e as m,w as x,V as T,W as I,X as E,Y as A,g as b,Z as B,S as O,f as R,B as V,a0 as H,a1 as j}from"./index-D3pJGQdL.js";import"./Check-C7VvBDFl.js";import"./installCanvasRenderer-DsW6pPxT.js";import"./use-theme-vars-CxNnKqFN.js";async function z(w,c,n="openChat",l={}){try{const r=new AbortController,d=l.timeout?setTimeout(()=>r.abort(),l.timeout):null,p=await fetch("http://localhost:11434/api/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:n,prompt:w,stream:!0}),signal:l.signal||r.signal});if(!p.ok)throw new Error(`请求失败: ${p.status} ${p.statusText}`);if(!p.body)throw new Error("响应体不可读");const v=p.body.getReader(),h=new TextDecoder("utf-8");let i="",f=!1;await(async()=>{try{for(;!f;){const{done:a,value:s}=await v.read();if(a){if(f=!0,i.trim())try{const t=JSON.parse(i);t.response&&c(t.response)}catch(t){console.warn("流结束时的缓冲区解析失败:",i,t)}break}i+=h.decode(s,{stream:!0});const e=i.split(`
`);i=e.pop()||"";for(const t of e)if(t.trim())try{const o=JSON.parse(t);if(o.done){f=!0;break}console.log(o),o.response&&(console.log(o),c(o.response))}catch(o){console.warn("流响应解析失败:",t,o),i=t+`
`+i;break}}}catch(a){if(a.name!=="AbortError")throw a}finally{d&&clearTimeout(d),v.releaseLock()}})()}catch(r){throw r.name==="AbortError"?new Error("请求超时"):r}}const J={class:"chat-page"},P={class:"chat-container"},W={key:0,class:"message ai loading"},$={class:"chat-input"},F=20,L=N({name:"chat",__name:"index",setup(w){const c=u(""),n=u([]),l=u(!1),r=u([]),d=u(!1),p=u(null),v=u(!1),h=u(0),i=a=>{const s=a.target,e=s.scrollTop,t=s.scrollHeight,o=s.clientHeight;v.value=e<h.value,t-(e+o)<50&&(v.value=!1),h.value=e},f=()=>{if(r.value.length===0||d.value)return;d.value=!0;const{index:a,token:s}=r.value.shift();n.value[a].displayContent||(n.value[a].displayContent="");let e=0;const t=setInterval(()=>{e<s.length?(n.value[a].displayContent+=s.charAt(e),e++):(clearInterval(t),d.value=!1,H(()=>{r.value.length>0&&f()}))},F)},_=async()=>{var t;const a=c.value.trim();if(!a)return;n.value.push({role:"user",content:a,displayContent:a}),c.value="",l.value=!0;const s={role:"ai",content:"",displayContent:"▋"};n.value.push(s);const e=n.value.length-1;try{await z(a,o=>{r.value.push({index:e,token:o}),n.value[e].content+=o,d.value||f()})}catch(o){n.value[e].displayContent="⚠️ AI 响应失败",console.error(o)}finally{(t=n.value[e].displayContent)!=null&&t.endsWith("▋")&&(n.value[e].displayContent=n.value[e].displayContent.slice(0,-1)),l.value=!1}};return(a,s)=>(y(),g("div",J,[C("div",P,[m(b(B),{ref_key:"scrollbarRef",ref:p,class:"chat-messages",onScroll:i,trigger:"none"},{default:x(()=>[(y(!0),g(I,null,E(n.value,(e,t)=>(y(),g("div",{key:t,class:A(["message",e.role])},[m(k,{content:e.content},null,8,["content"])],2))),128)),l.value?(y(),g("div",W,[m(b(S),{size:"small"})])):T("",!0)]),_:1},512),C("div",$,[m(b(O),{value:c.value,"onUpdate:value":s[0]||(s[0]=e=>c.value=e),type:"textarea",placeholder:"请输入你的问题...",disabled:l.value,autosize:{minRows:5,maxRows:5}},null,8,["value","disabled"]),m(b(V),{type:"primary",onClick:_,disabled:l.value||!c.value.trim(),loading:l.value},{default:x(()=>s[1]||(s[1]=[R(" 发送 ")])),_:1},8,["disabled","loading"])])])]))}}),Z=j(L,[["__scopeId","data-v-cccd7bbe"]]);export{Z as default};
