var G=Object.defineProperty;var K=(r,e,t)=>e in r?G(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var v=(r,e,t)=>K(r,typeof e!="symbol"?e+"":e,t);import{q as J,p as k,s as T,d as N,v as Q,x as X,y as L,U as Y,c as D,C as w,D as Z,F as C,e as u,a2 as ee,a3 as I,f as y,B as te}from"./index-D3pJGQdL.js";import{C as A,N as E}from"./CloudUploadOutline-BAOOvIVW.js";import{u as ae}from"./use-theme-vars-CxNnKqFN.js";const re=J("h",`
 font-size: var(--n-font-size);
 font-weight: var(--n-font-weight);
 margin: var(--n-margin);
 transition: color .3s var(--n-bezier);
 color: var(--n-text-color);
`,[k("&:first-child",{marginTop:0}),T("prefix-bar",{position:"relative",paddingLeft:"var(--n-prefix-width)"},[T("align-text",{paddingLeft:0},[k("&::before",{left:"calc(-1 * var(--n-prefix-width))"})]),k("&::before",`
 content: "";
 width: var(--n-bar-width);
 border-radius: calc(var(--n-bar-width) / 2);
 transition: background-color .3s var(--n-bezier);
 left: 0;
 top: 0;
 bottom: 0;
 position: absolute;
 `),k("&::before",{backgroundColor:"var(--n-bar-color)"})])]),ne=Object.assign(Object.assign({},L.props),{type:{type:String,default:"default"},prefix:String,alignText:Boolean}),ie=r=>N({name:`H${r}`,props:ne,setup(e){const{mergedClsPrefixRef:t,inlineThemeDisabled:s}=X(e),l=L("Typography","-h",re,Y,e,t),o=D(()=>{const{type:c}=e,{common:{cubicBezierEaseInOut:d},self:{headerFontWeight:i,headerTextColor:b,[w("headerPrefixWidth",r)]:p,[w("headerFontSize",r)]:F,[w("headerMargin",r)]:x,[w("headerBarWidth",r)]:f,[w("headerBarColor",c)]:P}}=l.value;return{"--n-bezier":d,"--n-font-size":F,"--n-margin":x,"--n-bar-color":P,"--n-bar-width":f,"--n-font-weight":i,"--n-text-color":b,"--n-prefix-width":p}}),n=s?Z(`h${r}`,D(()=>e.type[0]),o,e):void 0;return{mergedClsPrefix:t,cssVars:s?void 0:o,themeClass:n==null?void 0:n.themeClass,onRender:n==null?void 0:n.onRender}},render(){var e;const{prefix:t,alignText:s,mergedClsPrefix:l,cssVars:o,$slots:n}=this;return(e=this.onRender)===null||e===void 0||e.call(this),Q(`h${r}`,{class:[`${l}-h`,`${l}-h${r}`,this.themeClass,{[`${l}-h--prefix-bar`]:t,[`${l}-h--align-text`]:s}],style:o},n)}}),me=ie("3");class le{constructor(e,t){v(this,"allowDirectory");v(this,"allowDirectoryDnd");this.allowDirectory=e,this.allowDirectoryDnd=t}createHandler(e){return{onDragOver:t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer&&(t.dataTransfer.dropEffect="copy")},onDragLeave:t=>{t.preventDefault(),t.stopPropagation()},onDrop:async t=>{var o,n;t.preventDefault(),t.stopPropagation();const s=(o=t.dataTransfer)==null?void 0:o.items,l=(n=t.dataTransfer)==null?void 0:n.files;try{if(s&&s.length>0){const c=await this.extractFiles(s);if(c.length>0){e(c);return}}l&&l.length>0&&e(Array.from(l))}catch(c){console.error("文件拖拽解析失败:",c)}}}}async extractFiles(e){const t=[],s=[];if(!!!(e[0]&&e[0].webkitGetAsEntry)){for(const o of Array.from(e)){const n=o.getAsFile();n&&t.push(n)}return t}for(const o of Array.from(e))o.kind==="file"&&s.push((async()=>{var c;const n=(c=o.webkitGetAsEntry)==null?void 0:c.call(o);if(n)if(n.isDirectory&&(this.allowDirectory||this.allowDirectoryDnd)){const d=await this.readDirectory(n);t.push(...d)}else if(n.isFile){const d=await this.getFileFromEntry(n);d&&t.push(d)}else{const d=o.getAsFile();d&&t.push(d)}})());return await Promise.allSettled(s),t}async readDirectory(e){const t=[],s=e.createReader();return new Promise(l=>{const o=()=>{s.readEntries(async n=>{if(!n.length){l(t);return}const c=[];for(const d of n)d.isFile?c.push((async()=>{const i=await this.getFileFromEntry(d);i&&t.push(i)})()):d.isDirectory&&c.push((async()=>{const i=await this.readDirectory(d);t.push(...i)})());await Promise.allSettled(c),o()},n=>{console.error(`读取目录失败 (${e.fullPath}):`,n),l(t)})};o()})}getFileFromEntry(e){return new Promise(t=>{e.file(s=>{try{Object.defineProperty(s,"webkitRelativePath",{value:e.fullPath.replace(/^\//,""),configurable:!0})}catch(l){console.warn("无法设置 webkitRelativePath:",l)}t(s)},s=>{console.error(`获取文件失败 (${e.fullPath}):`,s),t(null)})})}}class oe{constructor(e){v(this,"config");v(this,"queue",[]);v(this,"isProcessing",!1);v(this,"counter",0);this.config=e}generateFileId(){return`file_${Date.now()}_${++this.counter}`}createUploadFileInfo(e){const t=e.webkitRelativePath||e.name;return{id:this.generateFileId(),name:e.name,status:"pending",percentage:0,file:e,fullPath:t}}async processFiles(e,t,s){if(this.isProcessing){this.queue.push(...e);return}this.isProcessing=!0;try{for(await this.runBatches(e,t,s);this.queue.length>0;){const l=this.queue.splice(0,this.config.batchSize);await this.runBatches(l,t,s)}}finally{this.isProcessing=!1}}async runBatches(e,t,s){const{batchSize:l,idleTimeout:o,maxConcurrent:n}=this.config;for(let c=0;c<e.length;c+=l){const d=e.slice(c,c+l);await this.runWithConcurrency(d,n,async i=>{const b=this.createUploadFileInfo(i);if(t)try{if(!await t.validate(i))return}catch(p){console.warn(`文件验证失败: ${i.name}`,p);return}s==null||s(b)}),c+l<e.length&&await this.waitForIdle(o)}}async runWithConcurrency(e,t,s){const l=[];for(const o of e){const n=Promise.resolve().then(()=>s(o)).finally(()=>{const c=l.indexOf(n);c>=0&&l.splice(c,1)});l.push(n),l.length>=t&&await Promise.race(l)}await Promise.all(l)}waitForIdle(e){return new Promise(t=>{typeof window<"u"&&"requestIdleCallback"in window?window.requestIdleCallback(t,{timeout:e}):setTimeout(t,e)})}}const ge=N({name:"CustomUpload",props:{multiple:{type:Boolean,default:!1},accept:{type:String,default:""},directory:{type:Boolean,default:!1},directoryDnd:{type:Boolean,default:!1},abstract:{type:Boolean,default:!1},max:{type:Number,default:1/0},maxSize:{type:Number,default:1/0},disabled:{type:Boolean,default:!1},batchSize:{type:Number,default:100},processingTimeout:{type:Number,default:20},concurrentLimit:{type:Number,default:5}},emits:["change","error","exceed"],setup(r,{slots:e,emit:t,expose:s}){const l=C(),o=C(!1),n=C(!1),c=C(!1),d=C(0),i=ae(),b=new oe({batchSize:r.batchSize,idleTimeout:r.processingTimeout,maxConcurrent:r.concurrentLimit}),p=new le(r.directory,r.directoryDnd),F=D(()=>r.accept?r.accept.split(",").map(a=>a.trim().toLowerCase()):[]),x=D(()=>r.max===1/0||d.value<r.max),f=D(()=>r.disabled||!x.value),P=a=>a<1024?`${a} B`:a<1024*1024?`${(a/1024).toFixed(2)} KB`:`${(a/(1024*1024)).toFixed(2)} MB`,R=a=>a.startsWith(".")?a:"."+a,O={validate:a=>{const m="."+a.name.toLowerCase().split(".").pop();return F.value.length>0&&!F.value.some(g=>m===R(g).toLowerCase())?(t("error",{file:a,message:`文件类型不支持: ${a.name}`}),!1):r.maxSize!==1/0&&a.size>r.maxSize?(t("error",{file:a,message:`文件大小超出限制: ${a.name} (${P(a.size)} / ${P(r.maxSize)})`}),!1):!0},getErrorMessage:a=>`文件验证失败: ${a.name}`},S=async a=>{if(r.disabled||a.length===0)return;const h=r.max===1/0?a.length:Math.max(0,r.max-d.value);if(h===0){t("exceed",{files:a,max:r.max});return}const m=a.slice(0,h);m.length<a.length&&t("exceed",{files:a.slice(h),max:r.max}),c.value=!0;const $=[];try{await b.processFiles(m,O,g=>{$.push({id:g.id,name:g.name,file:g.file,fullPath:g.fullPath,size:g.file.size,type:g.file.type,status:"pending",percentage:0}),d.value++}),$.length>0&&t("change",$)}finally{c.value=!1}},z=a=>{var h;f.value||(a==null||a.preventDefault(),a==null||a.stopPropagation(),(h=l.value)==null||h.click())},M=a=>{var m;const h=a.target;(m=h.files)!=null&&m.length&&(S(Array.from(h.files)),h.value="")},B=p.createHandler(S),H=a=>{f.value||(a.preventDefault(),a.stopPropagation(),B.onDragOver(a),o.value=!0)},V=a=>{r.disabled||(a.preventDefault(),a.stopPropagation(),B.onDragLeave(a),o.value=!1)},W=async a=>{f.value||(a.preventDefault(),a.stopPropagation(),o.value=!1,await B.onDrop(a))},q=()=>{f.value||(n.value=!0)},U=()=>{n.value=!1};s({triggerFileSelect:z,reset:()=>{d.value=0}});const j=()=>({borderColor:o.value?i.value.primaryColor:n.value&&!f.value?i.value.primaryColorHover:f.value?i.value.borderColor:i.value.dividerColor,backgroundColor:o.value?`${i.value.primaryColor}12`:n.value&&!f.value?`${i.value.primaryColor}08`:f.value?i.value.actionColor:"transparent",opacity:f.value?.6:1,cursor:f.value?"not-allowed":"pointer"}),_=()=>({transform:o.value?"scale(1.1)":n.value?"scale(1.05)":"scale(1)",color:o.value?i.value.primaryColor:n.value?i.value.primaryColorHover:i.value.textColor3});return()=>{var h;const a=u("input",ee({ref:l,type:"file",multiple:r.multiple,accept:r.accept},r.directory?{webkitdirectory:!0}:{},{class:"hidden",onChange:M,disabled:f.value}),null);return r.abstract?u("div",{class:"inline-block w-full"},[a,u("div",{class:"relative rounded-lg border-2 border-dashed transition-all duration-200 ease-in-out overflow-hidden",style:j(),onClick:z,onDrop:W,onDragover:H,onDragleave:V,onDragenter:m=>m.preventDefault(),onMouseenter:q,onMouseleave:U},[((h=e.default)==null?void 0:h.call(e,{isDragOver:o.value,isProcessing:c.value,canAddMore:x.value,fileCount:d.value,maxFiles:r.max}))||u("div",{class:"py-4 px-6 text-center"},[u("div",{class:"inline-flex items-center justify-center mb-4 transition-all duration-300",style:_()},[u(I,{size:48},{default:()=>[u(A,null,null)]})]),u(E,{class:"block text-base font-medium mb-2",style:{color:i.value.textColor1}},{default:()=>[o.value?"释放以上传文件":"点击或拖拽文件到此区域"]}),u(E,{depth:3,class:"block text-sm mb-3",style:{color:i.value.textColor3}},{default:()=>[r.multiple?"支持单个或批量上传":"支持单个文件上传"]}),u("div",{class:"inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium",style:{backgroundColor:i.value.buttonColor2,color:i.value.textColor2}},[u("span",null,[y("已上传: ")]),u("span",{class:"ml-1 font-semibold",style:{color:i.value.primaryColor}},[d.value]),u("span",{class:"mx-1"},[y("/")]),u("span",null,[r.max===1/0?"∞":r.max])]),c.value&&u("div",{class:"mt-5 flex items-center justify-center gap-2 px-4 py-2 rounded-lg",style:{backgroundColor:`${i.value.primaryColor}10`,borderLeft:`3px solid ${i.value.primaryColor}`}},[u("div",{class:"w-4 h-4 border-2 border-t-transparent rounded-full animate-spin",style:{borderColor:i.value.primaryColor}},null),u(E,{style:{color:i.value.primaryColor}},{default:()=>[y("正在处理文件...")]})])])]),!x.value&&r.max!==1/0&&u("div",{class:"mt-3 px-3 py-2 rounded-md text-xs text-center",style:{backgroundColor:`${i.value.warningColor}15`,color:i.value.warningColor,border:`1px solid ${i.value.warningColor}40`}},[y("⚠️ 已达到最大文件数量限制 ("),r.max,y(")")])]):u("div",{class:"inline-block"},[a,u(te,{onClick:z,disabled:f.value,loading:c.value,size:"medium",secondary:!0,style:{borderRadius:i.value.borderRadius}},{default:()=>{var m;return[((m=e.default)==null?void 0:m.call(e))||u("span",{class:"flex items-center gap-2"},[u(I,{size:18},{default:()=>[u(A,null,null)]}),u("span",null,[y("选择文件")])])]}}),!x.value&&r.max!==1/0&&u("div",{class:"mt-2 px-2 py-1 rounded text-xs inline-block",style:{backgroundColor:`${i.value.warningColor}15`,color:i.value.warningColor}},[y("已达到限制 ("),r.max,y(")")])])}}});export{ge as C,me as N};
