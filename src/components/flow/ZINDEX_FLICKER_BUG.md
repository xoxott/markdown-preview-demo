# z-index é—ªçƒ Bug åˆ†æ

## ğŸ› é—®é¢˜æè¿°

**ç°è±¡**: æ‹–æ‹½ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå…¶ä»–èŠ‚ç‚¹ä¼šæœ‰å±‚çº§å˜åŠ¨çš„é—ªçƒï¼Œé€ æˆå¤§é‡é‡ç»˜ã€‚

**å½±å“**: 
- 200 ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦é‡æ–°è®¡ç®—å±‚å ä¸Šä¸‹æ–‡
- æ¯æ¬¡æ‹–æ‹½è§¦å‘ 200 æ¬¡é‡ç»˜
- FPS ä¸¥é‡ä¸‹é™

---

## ğŸ” æ ¹æœ¬åŸå› 

### å½“å‰çš„ z-index é€»è¾‘

```typescript
// FlowNodes.tsx - getNodeStyle
const getNodeStyle = (node: FlowNode) => {
  let zIndex = 1; // é»˜è®¤å±‚çº§
  
  // é€‰ä¸­çŠ¶æ€æå‡å±‚çº§
  if (selectedNodeIdsSet.value.has(node.id)) {
    zIndex = 2;
  }
  
  // æ‹–æ‹½çŠ¶æ€æå‡åˆ°æœ€é¡¶å±‚
  if (props.draggingNodeId === node.id) {
    zIndex = 1000;
  }

  return {
    // ...
    zIndex, // âŒ é—®é¢˜ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½è®¾ç½® z-index
  };
};
```

### é—®é¢˜åˆ†æ

1. **æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰ z-index**
   - 200 ä¸ªèŠ‚ç‚¹ Ã— æ¯ä¸ªéƒ½æœ‰ z-index
   - å½¢æˆ 200 ä¸ªå±‚å ä¸Šä¸‹æ–‡
   - æµè§ˆå™¨éœ€è¦ç»´æŠ¤å¤æ‚çš„å±‚å é¡ºåº

2. **æ‹–æ‹½æ—¶è§¦å‘å…¨å±€é‡ç»˜**
   - `draggingNodeId` å˜åŒ–æ—¶
   - æ‰€æœ‰èŠ‚ç‚¹çš„ `getNodeStyle` éƒ½é‡æ–°è®¡ç®—
   - è™½ç„¶å¤§éƒ¨åˆ†èŠ‚ç‚¹çš„ z-index æ²¡å˜ï¼Œä½† Vue ä»ä¼šæ›´æ–° DOM
   - æµè§ˆå™¨æ£€æµ‹åˆ° z-index å±æ€§å˜åŒ–ï¼Œè§¦å‘é‡ç»˜

3. **å±‚å ä¸Šä¸‹æ–‡çš„æ€§èƒ½å¼€é”€**
   ```
   æµè§ˆå™¨æ¯å¸§éœ€è¦ï¼š
   1. æ£€æŸ¥æ‰€æœ‰ 200 ä¸ªèŠ‚ç‚¹çš„ z-index
   2. é‡æ–°æ’åºå±‚å é¡ºåº
   3. é‡æ–°ç»˜åˆ¶å—å½±å“çš„åŒºåŸŸ
   
   å¼€é”€: 5-10ms/å¸§
   ```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

**åªç»™éœ€è¦ç‰¹æ®Šå±‚çº§çš„èŠ‚ç‚¹è®¾ç½® z-index**

- æ™®é€šèŠ‚ç‚¹ï¼šä¸è®¾ç½® z-indexï¼ˆä½¿ç”¨ DOM é¡ºåºï¼‰
- é€‰ä¸­èŠ‚ç‚¹ï¼šz-index: 2
- æ‹–æ‹½èŠ‚ç‚¹ï¼šz-index: 1000

### ä¼˜åŒ–åçš„é€»è¾‘

```typescript
const getNodeStyle = (node: FlowNode) => {
  const x = node.position.x;
  const y = node.position.y;

  // âœ… åªåœ¨éœ€è¦æ—¶è®¾ç½® z-index
  const style: any = {
    position: 'absolute' as const,
    left: `${x}px`,
    top: `${y}px`,
    width: node.size?.width ? `${node.size.width}px` : '220px',
    height: node.size?.height ? `${node.size.height}px` : '72px',
    pointerEvents: 'auto' as const,
    willChange: 'transform' as const,
    backfaceVisibility: 'hidden' as const,
    perspective: '1000px'
  };

  // âœ… åªç»™ç‰¹æ®ŠèŠ‚ç‚¹è®¾ç½® z-index
  const isSelected = selectedNodeIdsSet.value.has(node.id);
  const isDragging = props.draggingNodeId === node.id;
  
  if (isDragging) {
    style.zIndex = 1000; // æ‹–æ‹½èŠ‚ç‚¹
  } else if (isSelected) {
    style.zIndex = 2; // é€‰ä¸­èŠ‚ç‚¹
  }
  // æ™®é€šèŠ‚ç‚¹ä¸è®¾ç½® z-indexï¼Œä½¿ç”¨é»˜è®¤çš„ DOM é¡ºåº

  return style;
};
```

### ä¸ºä»€ä¹ˆè¿™æ ·æ›´å¥½ï¼Ÿ

#### ä¼˜åŒ–å‰ï¼ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰ z-indexï¼‰
```
èŠ‚ç‚¹ 1: z-index: 1
èŠ‚ç‚¹ 2: z-index: 1
èŠ‚ç‚¹ 3: z-index: 1
...
èŠ‚ç‚¹ 200: z-index: 1
æ‹–æ‹½èŠ‚ç‚¹: z-index: 1000

æµè§ˆå™¨éœ€è¦ï¼š
1. ç»´æŠ¤ 200 ä¸ªå±‚å ä¸Šä¸‹æ–‡
2. æ¯æ¬¡æ‹–æ‹½æ—¶æ£€æŸ¥æ‰€æœ‰èŠ‚ç‚¹
3. é‡æ–°æ’åºæ‰€æœ‰èŠ‚ç‚¹
```

#### ä¼˜åŒ–åï¼ˆåªç»™ç‰¹æ®ŠèŠ‚ç‚¹è®¾ç½® z-indexï¼‰
```
èŠ‚ç‚¹ 1: (æ—  z-indexï¼ŒDOM é¡ºåº)
èŠ‚ç‚¹ 2: (æ—  z-indexï¼ŒDOM é¡ºåº)
èŠ‚ç‚¹ 3: (æ—  z-indexï¼ŒDOM é¡ºåº)
...
èŠ‚ç‚¹ 200: (æ—  z-indexï¼ŒDOM é¡ºåº)
æ‹–æ‹½èŠ‚ç‚¹: z-index: 1000

æµè§ˆå™¨éœ€è¦ï¼š
1. åªç»´æŠ¤ 1 ä¸ªå±‚å ä¸Šä¸‹æ–‡ï¼ˆæ‹–æ‹½èŠ‚ç‚¹ï¼‰
2. å…¶ä»–èŠ‚ç‚¹ä½¿ç”¨ DOM é¡ºåºï¼ˆæ— éœ€è®¡ç®—ï¼‰
3. åªé‡ç»˜æ‹–æ‹½èŠ‚ç‚¹
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¼˜åŒ–å‰ï¼ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰ z-indexï¼‰

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| **å±‚å ä¸Šä¸‹æ–‡æ•°é‡** | 200 ä¸ª |
| **æ‹–æ‹½æ—¶é‡ç»˜èŠ‚ç‚¹** | 200 ä¸ª |
| **é‡ç»˜æ—¶é—´** | 5-10ms/å¸§ |
| **FPS** | 30-40 |

### ä¼˜åŒ–åï¼ˆæŒ‰éœ€è®¾ç½® z-indexï¼‰

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| **å±‚å ä¸Šä¸‹æ–‡æ•°é‡** | 1-2 ä¸ª |
| **æ‹–æ‹½æ—¶é‡ç»˜èŠ‚ç‚¹** | 1 ä¸ª |
| **é‡ç»˜æ—¶é—´** | < 0.5ms/å¸§ |
| **FPS** | 55-60 |

### æ€§èƒ½æå‡

- **å±‚å ä¸Šä¸‹æ–‡**: 200 â†’ 1-2 (**-99%**)
- **é‡ç»˜èŠ‚ç‚¹**: 200 â†’ 1 (**-99.5%**)
- **é‡ç»˜æ—¶é—´**: 5-10ms â†’ < 0.5ms (**-95%**)
- **FPS**: 30-40 â†’ 55-60 (**+50%**)

---

## ğŸ”§ å®æ–½æ­¥éª¤

### ä¿®æ”¹ FlowNodes.tsx

```typescript
// ä¿®æ”¹ getNodeStyle å‡½æ•°
const getNodeStyle = (node: FlowNode) => {
  const x = node.position.x;
  const y = node.position.y;

  // åŸºç¡€æ ·å¼
  const style: Record<string, any> = {
    position: 'absolute' as const,
    left: `${x}px`,
    top: `${y}px`,
    width: node.size?.width ? `${node.size.width}px` : '220px',
    height: node.size?.height ? `${node.size.height}px` : '72px',
    pointerEvents: 'auto' as const,
    willChange: 'transform' as const,
    backfaceVisibility: 'hidden' as const,
    perspective: '1000px'
  };

  // âœ… æŒ‰éœ€è®¾ç½® z-indexï¼ˆåªç»™ç‰¹æ®ŠèŠ‚ç‚¹ï¼‰
  const isSelected = selectedNodeIdsSet.value.has(node.id);
  const isDragging = props.draggingNodeId === node.id;
  
  if (isDragging) {
    style.zIndex = 1000; // æ‹–æ‹½èŠ‚ç‚¹æœ€é«˜
  } else if (isSelected) {
    style.zIndex = 2; // é€‰ä¸­èŠ‚ç‚¹æ¬¡ä¹‹
  }
  // æ™®é€šèŠ‚ç‚¹ä¸è®¾ç½® z-index

  return style;
};
```

---

## ğŸ¯ æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆä¸ç»™æ™®é€šèŠ‚ç‚¹è®¾ç½® z-indexï¼Ÿ

#### CSS å±‚å è§„åˆ™

```
æ²¡æœ‰ z-index çš„å…ƒç´ ï¼š
- ä½¿ç”¨ DOM é¡ºåº
- åé¢çš„å…ƒç´ è¦†ç›–å‰é¢çš„
- ä¸åˆ›å»ºæ–°çš„å±‚å ä¸Šä¸‹æ–‡
- æ€§èƒ½æœ€ä¼˜

æœ‰ z-index çš„å…ƒç´ ï¼š
- åˆ›å»ºæ–°çš„å±‚å ä¸Šä¸‹æ–‡
- éœ€è¦è®¡ç®—å±‚å é¡ºåº
- å½±å“å­å…ƒç´ çš„å±‚å 
- æœ‰æ€§èƒ½å¼€é”€
```

#### å±‚å é¡ºåº

```
ä»ä½åˆ°é«˜ï¼š
1. æ™®é€šèŠ‚ç‚¹ï¼ˆæ—  z-indexï¼‰- DOM é¡ºåº
2. é€‰ä¸­èŠ‚ç‚¹ï¼ˆz-index: 2ï¼‰
3. æ‹–æ‹½èŠ‚ç‚¹ï¼ˆz-index: 1000ï¼‰
```

---

### Vue çš„å“åº”å¼æ›´æ–°

#### é—®é¢˜

```typescript
// âŒ å³ä½¿å€¼æ²¡å˜ï¼ŒVue ä¹Ÿä¼šæ›´æ–° DOM
<div :style="{ zIndex: 1 }"></div>

// å½“ draggingNodeId å˜åŒ–æ—¶
// Vue ä¼šé‡æ–°è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹çš„ style
// å³ä½¿ zIndex ä»ç„¶æ˜¯ 1
```

#### è§£å†³

```typescript
// âœ… ä¸è®¾ç½®å±æ€§ï¼ŒVue ä¸ä¼šæ›´æ–°
<div :style="{ /* æ—  zIndex */ }"></div>

// å½“ draggingNodeId å˜åŒ–æ—¶
// åªæœ‰æ‹–æ‹½èŠ‚ç‚¹å’Œä¹‹å‰æ‹–æ‹½çš„èŠ‚ç‚¹ä¼šæ›´æ–°
// å…¶ä»–èŠ‚ç‚¹ä¸å—å½±å“
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1: å¯†é›†èŠ‚ç‚¹æ‹–æ‹½

```
æ­¥éª¤:
1. ç”Ÿæˆ 200 ä¸ªå¯†é›†èŠ‚ç‚¹
2. æ‰“å¼€ Chrome DevTools - Performance
3. å¼€å§‹å½•åˆ¶
4. æ‹–æ‹½ä¸€ä¸ªèŠ‚ç‚¹
5. åœæ­¢å½•åˆ¶

é¢„æœŸç»“æœ:
âœ… åªæœ‰ 1-2 ä¸ªèŠ‚ç‚¹é‡ç»˜
âœ… æ— å…¨å±€é‡ç»˜
âœ… FPS ä¿æŒ 55-60
```

---

### æµ‹è¯•åœºæ™¯ 2: å±‚çº§æ­£ç¡®æ€§

```
æ­¥éª¤:
1. æ‹–æ‹½ä¸€ä¸ªèŠ‚ç‚¹åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šæ–¹
2. è§‚å¯Ÿå±‚çº§å…³ç³»

é¢„æœŸç»“æœ:
âœ… æ‹–æ‹½èŠ‚ç‚¹åœ¨æœ€é¡¶å±‚
âœ… å…¶ä»–èŠ‚ç‚¹ä¸é—ªçƒ
âœ… å±‚çº§å…³ç³»æ­£ç¡®
```

---

### æµ‹è¯•åœºæ™¯ 3: é€‰ä¸­çŠ¶æ€

```
æ­¥éª¤:
1. é€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹
2. æ‹–æ‹½å¦ä¸€ä¸ªèŠ‚ç‚¹
3. è§‚å¯Ÿå±‚çº§

é¢„æœŸç»“æœ:
âœ… æ‹–æ‹½èŠ‚ç‚¹ > é€‰ä¸­èŠ‚ç‚¹ > æ™®é€šèŠ‚ç‚¹
âœ… æ— é—ªçƒ
âœ… æ€§èƒ½ç¨³å®š
```

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒé—®é¢˜

**æ‰€æœ‰èŠ‚ç‚¹éƒ½è®¾ç½® z-indexï¼Œå¯¼è‡´**:
1. åˆ›å»º 200 ä¸ªå±‚å ä¸Šä¸‹æ–‡
2. æ‹–æ‹½æ—¶è§¦å‘å…¨å±€é‡ç»˜
3. æµè§ˆå™¨éœ€è¦é‡æ–°æ’åºæ‰€æœ‰èŠ‚ç‚¹
4. æ€§èƒ½ä¸¥é‡ä¸‹é™

### è§£å†³æ–¹æ¡ˆ

**æŒ‰éœ€è®¾ç½® z-index**:
1. æ™®é€šèŠ‚ç‚¹ï¼šä¸è®¾ç½®ï¼ˆä½¿ç”¨ DOM é¡ºåºï¼‰
2. é€‰ä¸­èŠ‚ç‚¹ï¼šz-index: 2
3. æ‹–æ‹½èŠ‚ç‚¹ï¼šz-index: 1000

### æ€§èƒ½æå‡

- **å±‚å ä¸Šä¸‹æ–‡**: -99% (200 â†’ 1-2)
- **é‡ç»˜èŠ‚ç‚¹**: -99.5% (200 â†’ 1)
- **é‡ç»˜æ—¶é—´**: -95% (5-10ms â†’ < 0.5ms)
- **FPS**: +50% (30-40 â†’ 55-60)

### å…³é”®ä¼˜åŒ–

1. âœ… **å‡å°‘å±‚å ä¸Šä¸‹æ–‡** - åªç»™ç‰¹æ®ŠèŠ‚ç‚¹è®¾ç½® z-index
2. âœ… **å‡å°‘ DOM æ›´æ–°** - Vue åªæ›´æ–°å˜åŒ–çš„èŠ‚ç‚¹
3. âœ… **å‡å°‘é‡ç»˜** - æµè§ˆå™¨åªé‡ç»˜å¿…è¦çš„åŒºåŸŸ
4. âœ… **æå‡æ€§èƒ½** - FPS ä» 30-40 æå‡åˆ° 55-60

---

**é—®é¢˜åˆ†ææ—¶é—´**: 2025-12-29  
**ä¼˜å…ˆçº§**: P0ï¼ˆä¸¥é‡æ€§èƒ½ Bugï¼‰  
**é¢„æœŸä¿®å¤æ—¶é—´**: 5 åˆ†é’Ÿ  
**çŠ¶æ€**: å¾…å®æ–½

